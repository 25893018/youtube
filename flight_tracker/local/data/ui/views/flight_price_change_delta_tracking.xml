<form>
  <label>Flight Price Monitoring - Advanced Filtering</label>
  <search>
    <query>|makeresults
     </query>
    <earliest>$departure_date.earliest$</earliest>
    <latest>$departure_date.latest$</latest>
    <progress>
      <eval token="tokEarliest">strptime($job.earliestTime$,"%Y-%m-%dT%H:%M:%S.%3N%z")</eval>
      <eval token="tokLatest">strptime($job.latestTime$,"%Y-%m-%dT%H:%M:%S.%3N%z")</eval>
    </progress>
  </search>
  <search id="flights_base_search">
    <query>
      index=flights 
| eval earliest = $tokEarliest$, latest = if ($tokLatest$ &lt; 0, now(),$tokLatest$)
| where dTime &gt;= earliest AND dTime &lt;= latest
|search flyFrom=$from_token$ flyTo=$to_token$  
| dedup "airlines{}" "route{}.flight_no" flyFrom flyTo
| rename "airlines{}" AS "airlines" , "route{}.flight_no" AS "flightNumber" , "departureTime" AS "departureDateTime" 
|  eval departureDate = strftime(dTime,"%Y-%m-%d"), departureTime = strftime(dTime,"%H:%M:%S")
| eval bag_price = coalesce('bags_price.2','bags_price.1')
| eval bag_price = if(bag_price="",0,bag_price)
| eval luggage_token = "$luggage_token$"
| eval is_bag = case (bag_price&gt;0 AND luggage_token = "*","(Extra Baggage Price Not Included)",bag_price&gt;0 AND luggage_token = "0","(Extra Baggage Price Included)",bag_price=0,"(Free Bag)",bag_price="","(Extra Baggage Not Allowed)")
| eval name = case(airlines="OA","Name1",airlines="CY","Cyprus",airlines="0B","Name2",airlines="ME","Name3")
| eval flightLabel = name + " " + flightNumber + " at " + departureTime + is_bag
| eval total_price = if(luggage_token = "0",price + bag_price,price)
| table _time, airlines,flyFrom,flyTo,price,flightNumber,flightLabel, departureDate, departureTime, bag_price, is_bag, name , total_price
    </query>
  </search>
  <fieldset submitButton="true" autoRun="true">
    <input type="time" token="departure_date">
      <label>Departure Date</label>
      <default>
        <earliest>-7d@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="from_token">
      <label>Fly From</label>
      <choice value="LCA">LCA</choice>
      <choice value="ATH">ATH</choice>
      <choice value="BEY">BEY</choice>
      <choice value="TLV">TLV</choice>
      <default>LCA</default>
    </input>
    <input type="dropdown" token="to_token">
      <label>Fly To</label>
      <choice value="LCA">LCA</choice>
      <choice value="ATH">ATH</choice>
      <choice value="BEY">BEY</choice>
      <choice value="TLV">TLV</choice>
      <default>ATH</default>
    </input>
    <input type="multiselect" token="airlines_token">
      <label>Airlines</label>
      <choice value="*">ALL</choice>
      <choice value="0B">0B</choice>
      <choice value="CY">CY</choice>
      <choice value="OA">OA</choice>
      <choice value="A3">A3</choice>
      <choice value="ME">ME</choice>
      <choice value="LY">LY</choice>
      <choice value="IZ">IZ</choice>
      <choice value="6H">6H</choice>
      <prefix>(</prefix>
      <suffix>)</suffix>
      <valuePrefix>airlines="</valuePrefix>
      <valueSuffix>"</valueSuffix>
      <delimiter> OR </delimiter>
      <default>*</default>
    </input>
    <input type="dropdown" token="luggage_token">
      <label>Luggage</label>
      <choice value="0">Show flights with bags included in price only</choice>
      <choice value="*">Show All Flights</choice>
      <default>*</default>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Prices per Flight</title>
      <chart>
        <search base="flights_base_search">
          <query>|chart min(total_price) over departureDate by flightLabel | fillnull </query>
        </search>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.chart">line</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.showDataLabels">minmax</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.legend.placement">right</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.splitBy">flightLabel</option>
      </chart>
    </panel>
    <panel>
      <chart>
        <search base="flights_base_search">
          <query>| table name,total_price</query>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.showDataLabels">all</option>
        <option name="charting.drilldown">none</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <table>
        <search base="flights_base_search">
          <query>|  table airlines,departureDate, total_price, flightNumber, flyFrom,flyTo,price,flightLabel, departureTime, bag_price,  name </query>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">heatmap</option>
        <option name="drilldown">none</option>
        <option name="rowNumbers">false</option>
        <option name="wrap">false</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Average Price for Departure Date per Airline</title>
      <chart>
        <search base="flights_base_search">
          <query>|chart avg(total_price) over departureDate by name | fillnull</query>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.showDataLabels">minmax</option>
        <option name="charting.drilldown">all</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
</form>